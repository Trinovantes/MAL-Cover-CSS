services:
  db:
    image: mariadb:10
    logging:
      driver: local
    volumes:
      - mysql-data:/var/lib/mysql
    secrets:
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
    environment:
      - MYSQL_DATABASE_FILE=/run/secrets/MYSQL_DATABASE
      - MYSQL_USER_FILE=/run/secrets/MYSQL_USER
      - MYSQL_PASSWORD_FILE=/run/secrets/MYSQL_PASSWORD
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/MYSQL_PASSWORD

  db-backup:
    image: malcovercss-db-backup
    logging:
      driver: local
    build:
      context: ../db
      target: backup
    depends_on:
      - db
    secrets:
      - MYSQL_HOST
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD

  db-migration:
    image: malcovercss-db-migration
    logging:
      driver: local
    build:
      context: ../db
      target: migration
    depends_on:
      - db
    secrets:
      - MYSQL_HOST
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD

  cache:
    image: redis:6.0-alpine
    logging:
      driver: local

  generator:
    image: malcovercss-generator
    logging:
      driver: local
    volumes:
      - generated:/app/static/generated
    build:
      context: ../
      dockerfile: src/cron/generator/Dockerfile
    depends_on:
      - db-migration
    secrets:
      - MYSQL_HOST
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD

  scraper:
    image: malcovercss-scraper
    logging:
      driver: local
    build:
      context: ../
      dockerfile: src/cron/scraper/Dockerfile
    depends_on:
      - db-migration
    secrets:
      - ENCRYPTION_KEY
      - MAL_CLIENT_ID
      - MAL_CLIENT_SECRET
      - MYSQL_HOST
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD

  www:
    image: malcovercss-www
    logging:
      driver: local
    volumes:
      - generated:/app/static/generated
    build:
      context: ../
      dockerfile: src/web/Dockerfile
    depends_on:
      - db-migration
      - cache
    secrets:
      - ENCRYPTION_KEY
      - MAL_CLIENT_ID
      - MAL_CLIENT_SECRET
      - MYSQL_HOST
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD

volumes:
  mysql-data:
  generated:

secrets:
  ENCRYPTION_KEY:
    file: ./secrets/ENCRYPTION_KEY.txt
  MAL_CLIENT_ID:
    file: ./secrets/MAL_CLIENT_ID.txt
  MAL_CLIENT_SECRET:
    file: ./secrets/MAL_CLIENT_SECRET.txt
  MYSQL_HOST:
    file: ./secrets/MYSQL_HOST.txt
  MYSQL_DATABASE:
    file: ./secrets/MYSQL_DATABASE.txt
  MYSQL_USER:
    file: ./secrets/MYSQL_USER.txt
  MYSQL_PASSWORD:
    file: ./secrets/MYSQL_PASSWORD.txt

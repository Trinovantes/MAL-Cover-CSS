#!/usr/bin/env node

'use strict';

const Config = require('config');
const kue = require('kue-scheduler');
const scrapeUsers = require('tasks/scraper');
const generateCSS = require('tasks/generator');
const logger = require("winston-color");

//-----------------------------------------------------------------------------
// Queue
//-----------------------------------------------------------------------------

let queue = kue.createQueue({ redis: Config.REDIS_Config });
queue.on('error', function(error) {
    logger.error('[Kue Error]', error);
});

//-----------------------------------------------------------------------------
// Scraper
//-----------------------------------------------------------------------------

let scrapJob = queue.create(Config.SCRAPE_USER_JOB_KEY).removeOnComplete(true).attempts(3).save();
queue.every('1 days', scrapJob);
queue.process(Config.SCRAPE_USER_JOB_KEY, function(job, done){
    scrapeUsers(function() {
        done();
    });
});

//-----------------------------------------------------------------------------
// Generator
//-----------------------------------------------------------------------------

let generateJob = queue.create(Config.GENERATE_CSS_JOB_KEY).removeOnComplete(true).attempts(3).save();
queue.every('1 days', generateJob);
queue.process(Config.GENERATE_CSS_JOB_KEY, function(job, done){
    generateCSS(function() {
        done();
    });
});
